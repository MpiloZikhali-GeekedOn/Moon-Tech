{% extends "base.html" %}

{% block title %}My Wishlist - Stokvel Sami{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-heart-fill text-danger me-2"></i>My Wishlist</h2>
            <p class="text-muted mb-0">Your saved products for stokvel shopping</p>
        </div>
        <div>
            <a href="{{ url_for('category_recommender') }}" class="btn btn-outline-primary me-2">
                <i class="bi bi-tags"></i> Browse Categories
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                <i class="bi bi-house"></i> Dashboard
            </a>
        </div>
    </div>

    <!-- Wishlist Container -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-bookmark-check me-2"></i>Your Stokvel Shopping List</h5>
        </div>
        <div class="card-body">
            <div id="wishlist-container">
                <!-- Empty State -->
                <div id="wishlistEmpty" class="text-center py-5">
                    <i class="bi bi-bag-x" style="font-size: 4rem; color: #dee2e6;"></i>
                    <h4 class="mt-3 text-muted">Your wishlist is empty</h4>
                    <p class="text-muted">Add products from recommendations to start your stokvel shopping list</p>
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <a href="{{ url_for('recommender') }}" class="btn btn-primary">
                            <i class="bi bi-stars"></i> Get Recommendations
                        </a>
                        <a href="{{ url_for('category_recommender') }}" class="btn btn-outline-primary">
                            <i class="bi bi-tags"></i> Browse Categories
                        </a>
                    </div>
                </div>

                <!-- Wishlist Content -->
                <div id="wishlistContent" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Shop</th>
                                    <th>Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="wishlistItems">
                                <!-- Items will be populated by JavaScript -->
                            </tbody>
                            <tfoot class="table-primary">
                                <tr>
                                    <th colspan="3" class="text-end">Total:</th>
                                    <th id="wishlistTotal" class="h5">$0.00</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Budget Progress -->
                    <div id="budgetProgress" class="card mt-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Budget Progress</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold">Budget Usage:</span>
                                <span id="budgetUsage" class="fw-bold">$0.00 / $0.00</span>
                            </div>
                            <div class="progress budget-meter" style="height: 20px;">
                                <div id="budgetProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="mt-2 d-flex justify-content-between">
                                <small class="text-muted" id="budgetRemaining">$0.00 remaining</small>
                                <small class="text-muted" id="budgetPercentage">0% used</small>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div>
                            <span class="badge bg-secondary" id="itemCount">0 items</span>
                        </div>
                        <div class="d-flex gap-2">
                            <button id="savePdf" class="btn btn-success">
                                <i class="bi bi-file-earmark-pdf"></i> Save as PDF
                            </button>
                            <button id="shareOptions" class="btn btn-primary">
                                <i class="bi bi-share"></i> Share with Stokvel
                            </button>
                            <button id="clearWishlist" class="btn btn-outline-danger">
                                <i class="bi bi-trash"></i> Clear All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stokvel Tips Section -->
    <div class="card mt-4 border-0 shadow-sm">
        <div class="card-body">
            <h5 class="card-title"><i class="bi bi-lightbulb text-warning me-2"></i>Stokvel Shopping Tips</h5>
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item border-0">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <small>Compare prices with your stokvel members before buying</small>
                        </li>
                        <li class="list-group-item border-0">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <small>Consider bulk purchases for better discounts</small>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item border-0">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <small>Assign different categories to different members</small>
                        </li>
                        <li class="list-group-item border-0">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <small>Schedule regular shopping trips with your stokvel</small>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Options Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-share me-2"></i>Share Your Wishlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Share your shopping list with your stokvel members</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="shareVia('email')">
                        <i class="bi bi-envelope me-2"></i> Email to Stokvel
                    </button>
                    <button class="btn btn-primary" onclick="shareVia('whatsapp')">
                        <i class="bi bi-whatsapp me-2"></i> WhatsApp Group
                    </button>
                    <button class="btn btn-info" onclick="shareVia('sms')">
                        <i class="bi bi-chat me-2"></i> SMS to Members
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SMS Modal -->
<div class="modal fade" id="smsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-chat me-2"></i>Send to Stokvel Members</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="phoneNumber" class="form-label">Phone Numbers</label>
                    <textarea class="form-control" id="phoneNumber" rows="3"
                              placeholder="Enter phone numbers separated by commas&#10;Example: 27607247435, 27612345678, 27609876543"
                              required></textarea>
                    <div class="form-text">Enter phone numbers with country code (e.g., 27607247435)</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendSmsBtn" onclick="sendSms()">
                    <i class="bi bi-send me-2"></i> Send to Members
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clear Confirmation Modal -->
<div class="modal fade" id="clearModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-warning me-2"></i>Clear Wishlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to clear your entire wishlist? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="clearWishlist()">
                    <i class="bi bi-trash me-2"></i> Clear All Items
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load wishlist from localStorage
        const savedWishlist = localStorage.getItem('userWishlist');
        const wishlist = savedWishlist ? JSON.parse(savedWishlist) : [];
        const userBudget = parseFloat(localStorage.getItem('userBudget') || 0);

        updateWishlistDisplay(wishlist, userBudget);

        // Set up event listeners
        document.getElementById('savePdf').addEventListener('click', function() {
            saveWishlistAsPdf(wishlist);
        });

        document.getElementById('shareOptions').addEventListener('click', function() {
            const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
            shareModal.show();
        });

        document.getElementById('clearWishlist').addEventListener('click', function() {
            const clearModal = new bootstrap.Modal(document.getElementById('clearModal'));
            clearModal.show();
        });

        // Add input validation for phone numbers
        document.getElementById('phoneNumber').addEventListener('input', function(e) {
            const sendBtn = document.getElementById('sendSmsBtn');
            sendBtn.disabled = !e.target.value.trim();
        });
    });

    function updateWishlistDisplay(wishlist, userBudget) {
        const emptyMessage = document.getElementById('wishlistEmpty');
        const wishlistContent = document.getElementById('wishlistContent');
        const itemsContainer = document.getElementById('wishlistItems');
        const budgetProgress = document.getElementById('budgetProgress');

        if (wishlist.length === 0) {
            emptyMessage.classList.remove('d-none');
            wishlistContent.classList.add('d-none');
            budgetProgress.classList.add('d-none');
            return;
        }

        emptyMessage.classList.add('d-none');
        wishlistContent.classList.remove('d-none');
        budgetProgress.classList.remove('d-none');

        itemsContainer.innerHTML = '';
        let total = 0;

        wishlist.forEach((product, index) => {
            total += product.price;
            itemsContainer.innerHTML += `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${product.image_url || 'https://via.placeholder.com/50x50?text=Product'}"
                                 class="rounded me-3" width="50" height="50" alt="${product.name}">
                            <div>
                                <h6 class="mb-0">${product.name}</h6>
                                <small class="text-muted">${product.weight}</small>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-secondary">${product.category}</span></td>
                    <td>${product.shop}</td>
                    <td class="fw-bold">$${product.price.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger remove-item" data-index="${index}">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    </td>
                </tr>
            `;
        });

        // Update total
        document.getElementById('wishlistTotal').textContent = `$${total.toFixed(2)}`;
        document.getElementById('itemCount').textContent = `${wishlist.length} ${wishlist.length === 1 ? 'item' : 'items'}`;

        // Update budget progress
        if (userBudget > 0) {
            const percentage = Math.min(100, (total / userBudget) * 100);
            const progressBar = document.getElementById('budgetProgressBar');
            const remaining = userBudget - total;

            progressBar.style.width = `${percentage}%`;
            progressBar.className = `progress-bar ${percentage > 90 ? 'bg-danger' : (percentage > 75 ? 'bg-warning' : 'bg-success')}`;

            document.getElementById('budgetUsage').textContent = `$${total.toFixed(2)} / $${userBudget.toFixed(2)}`;
            document.getElementById('budgetRemaining').textContent = `$${Math.max(0, remaining).toFixed(2)} remaining`;
            document.getElementById('budgetPercentage').textContent = `${percentage.toFixed(1)}% used`;
        } else {
            document.getElementById('budgetUsage').textContent = `$${total.toFixed(2)} (no budget set)`;
            document.getElementById('budgetRemaining').textContent = 'Set a budget in your dashboard';
            document.getElementById('budgetPercentage').textContent = '';
        }

        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-item').forEach(button => {
            button.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                const wishlist = JSON.parse(localStorage.getItem('userWishlist') || '[]');
                const removedProduct = wishlist[index];

                wishlist.splice(index, 1);
                localStorage.setItem('userWishlist', JSON.stringify(wishlist));

                updateWishlistDisplay(wishlist, userBudget);
                showToast(`"${removedProduct.name}" removed from your stokvel list.`, 'info');
            });
        });
    }

    function saveWishlistAsPdf(wishlist) {
        fetch('/save_wishlist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({wishlist: wishlist})
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'stokvel_sami_wishlist.pdf';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('Wishlist saved as PDF! Share it with your stokvel.', 'success');
        })
        .catch(error => {
            console.error('Error saving PDF:', error);
            showToast('Error saving PDF. Please try again.', 'danger');
        });
    }

    function shareVia(method) {
        const wishlist = JSON.parse(localStorage.getItem('userWishlist') || '[]');

        if (wishlist.length === 0) {
            showToast('Your stokvel list is empty', 'warning');
            return;
        }

        if (method === 'sms') {
            const smsModal = new bootstrap.Modal(document.getElementById('smsModal'));
            document.getElementById('phoneNumber').value = '';
            document.getElementById('sendSmsBtn').disabled = true;
            smsModal.show();
        } else {
            const total = wishlist.reduce((sum, item) => sum + item.price, 0);
            const itemCount = wishlist.length;
            let message = `Ready to share your stokvel list with ${itemCount} items (Total: $${total.toFixed(2)}) via ${method}.`;
            showToast(message, 'info');
        }

        const modal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
        modal.hide();
    }

    function sendSms() {
        const phoneNumbers = document.getElementById('phoneNumber').value.trim();
        const wishlist = JSON.parse(localStorage.getItem('userWishlist') || '[]');
        const sendBtn = document.getElementById('sendSmsBtn');

        if (!phoneNumbers) {
            showToast('Please enter phone numbers', 'warning');
            return;
        }

        if (wishlist.length === 0) {
            showToast('Stokvel list is empty', 'warning');
            return;
        }

        // Show loading state
        const originalText = sendBtn.innerHTML;
        sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Sending...';
        sendBtn.disabled = true;

        fetch('/send_wishlist_sms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                wishlist: wishlist,
                phone_number: phoneNumbers
            })
        })
        .then(response => response.json())
        .then(data => {
            // Restore button state
            sendBtn.innerHTML = originalText;
            sendBtn.disabled = false;

            if (data.success) {
                showToast('List shared with stokvel members!', 'success');
                const smsModal = bootstrap.Modal.getInstance(document.getElementById('smsModal'));
                smsModal.hide();
            } else {
                showToast(data.error, 'danger');
            }
        })
        .catch(error => {
            // Restore button state
            sendBtn.innerHTML = originalText;
            sendBtn.disabled = false;
            showToast('Error sending messages. Please try again.', 'danger');
        });
    }

    function clearWishlist() {
        localStorage.removeItem('userWishlist');
        updateWishlistDisplay([], parseFloat(localStorage.getItem('userBudget') || 0));
        showToast('Stokvel list cleared', 'info');

        const clearModal = bootstrap.Modal.getInstance(document.getElementById('clearModal'));
        clearModal.hide();
    }

    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');

        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;

        // Add to container or create one
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }

        toastContainer.appendChild(toast);

        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', function () {
            toast.remove();
        });
    }
</script>

<style>
    .wishlist-item {
        transition: background-color 0.2s ease;
    }

    .wishlist-item:hover {
        background-color: #f8f9fa;
    }

    .budget-meter {
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-bar {
        transition: width 0.5s ease;
    }

    .toast-container {
        z-index: 1090;
    }

    .table th {
        border-top: none;
        font-weight: 600;
    }
</style>
{% endblock %}